{% extends "base.html" %}
{% block title %}Patient Bed Requests{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-primary">
            <i class="fas fa-procedures me-2"></i>Patient Bed Requests
        </h3>
        <input type="text" id="searchInput" class="form-control w-25" placeholder="Search patient, doctor, or ward...">
    </div>

    {% if bed_requests %}
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-striped table-hover align-middle" id="patientsTable">
            <thead class="table-primary">
                <tr>
                    <th>#</th>
                    <th>Patient</th>
                    <th>Doctor</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for req in bed_requests %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ req.appointment.patient.user.get_full_name }}</td>
                    <td>{{ req.requested_by.get_full_name }}</td>
                    <td>
                        {% if req.status == "pending" %}
                            <a href="{% url 'assign_bed' req.id %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-bed me-1"></i> Assign Bed
                            </a>
                        {% elif req.status == "fulfilled" and req.assignment.first %}
                            <button class="btn btn-sm btn-outline-info viewBtn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#viewBedModal"
                                    data-patient="{{ req.appointment.patient.user.get_full_name }}"
                                    data-doctor="{{ req.requested_by.get_full_name }}"
                                    data-ward="{{ req.assignment.first.bed.ward }}"
                                    data-bed="{{ req.assignment.first.bed.bed_number }}"
                                    data-nurse="{{ req.fulfilled_by.get_full_name }}"
                                    data-date="{{ req.assignment.first.date_assigned|date:'M d, Y h:i A' }}"
                                    data-status="{{ req.assignment.first.bed.status }}"
                                    data-assignment="{{ req.assignment.first.id }}">
                                <i class="fas fa-eye me-1"></i> View
                            </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-center mt-3">
        <button id="prevPage" class="btn btn-secondary me-2">Previous</button>
        <span id="pageInfo" class="align-self-center"></span>
        <button id="nextPage" class="btn btn-secondary ms-2">Next</button>
    </div>

    {% else %}
        <div class="alert alert-info mt-4">No patient bed requests found.</div>
    {% endif %}
</div>

<!-- Bed Details Modal -->
<div class="modal fade" id="viewBedModal" tabindex="-1" aria-labelledby="viewBedModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="viewBedModalLabel"><i class="fas fa-bed me-2"></i>Bed Assignment Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" id="releaseBedForm">
        {% csrf_token %}
        <div class="modal-body">
            <p><strong>Patient:</strong> <span id="modalPatient"></span></p>
            <p><strong>Doctor:</strong> <span id="modalDoctor"></span></p>
            <p><strong>Ward:</strong> <span id="modalWard"></span></p>
            <p><strong>Bed Number:</strong> <span id="modalBed"></span></p>
            <p><strong>Status:</strong> <span id="modalStatus" class="fw-bold"></span></p>
            <p><strong>Fulfilled By:</strong> <span id="modalNurse"></span></p>
            <p><strong>Date Assigned:</strong> <span id="modalDate"></span></p>
        </div>
        <div class="modal-footer">
            <button type="submit" class="btn btn-warning" id="releaseBtn">Release Bed</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JS: Search + Pagination + Modal -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const rowsPerPage = 8;
    const table = document.getElementById("patientsTable");
    const allRows = Array.from(table.querySelectorAll("tbody tr"));
    const searchInput = document.getElementById("searchInput");
    const prevBtn = document.getElementById("prevPage");
    const nextBtn = document.getElementById("nextPage");
    const pageInfo = document.getElementById("pageInfo");

    let currentPage = 1;
    let filteredRows = [...allRows];

    function renderTable() {
        allRows.forEach(row => row.style.display = "none");
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        filteredRows.slice(start, end).forEach(row => row.style.display = "");
        pageInfo.textContent = filteredRows.length > 0 ? `Page ${currentPage} of ${totalPages}` : "No results";
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage >= totalPages;
    }

    prevBtn.addEventListener("click", () => {
        if (currentPage > 1) currentPage--;
        renderTable();
    });

    nextBtn.addEventListener("click", () => {
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
        if (currentPage < totalPages) currentPage++;
        renderTable();
    });

    searchInput.addEventListener("input", () => {
        const query = searchInput.value.toLowerCase();
        filteredRows = allRows.filter(row => row.textContent.toLowerCase().includes(query));
        currentPage = 1;
        renderTable();
    });

    renderTable();

    // Modal: Populate data
    const viewButtons = document.querySelectorAll(".viewBtn");
    const releaseForm = document.getElementById("releaseBedForm");
    const releaseBtn = document.getElementById("releaseBtn");

    viewButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            document.getElementById("modalPatient").textContent = btn.dataset.patient;
            document.getElementById("modalDoctor").textContent = btn.dataset.doctor;
            document.getElementById("modalWard").textContent = btn.dataset.ward;
            document.getElementById("modalBed").textContent = btn.dataset.bed;
            document.getElementById("modalNurse").textContent = btn.dataset.nurse;
            document.getElementById("modalDate").textContent = btn.dataset.date;

            // Show bed status
            const bedStatus = btn.dataset.status;
            document.getElementById("modalStatus").textContent = bedStatus.charAt(0).toUpperCase() + bedStatus.slice(1);

            // Only show Release button if bed is occupied
            if(bedStatus === "occupied") {
                releaseBtn.style.display = "inline-block";
            } else {
                releaseBtn.style.display = "none";
            }

            // Set form action dynamically with assignment id
            const assignmentId = btn.dataset.assignment;
            releaseForm.action = `/release-bed/${assignmentId}/`;
        });
    });
});
</script>
{% endblock %}
