{% extends "base.html" %}

{% block title %}User List{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">User List</h2>

    <!-- Filters: Search + Role -->
    <div class="row mb-3">
        <div class="col-md-6 mb-2">
            <input type="text" class="form-control" id="searchInput" placeholder="Search users...">
        </div>
        <div class="col-md-4 mb-2">
            <select class="form-select" id="roleFilter">
                <option value="">All Roles</option>
                <option value="admin">Admin</option>
                <option value="doctor">Doctor</option>
                <option value="nurse">Nurse</option>
                <option value="reception">Receptionist</option>
                <option value="labtech">Lab Technician</option>
                <option value="pharmacist">Pharmacist</option>
                <!-- Add more roles as needed -->
            </select>
        </div>
    </div>

    <!-- User Table -->
    <div class="table-responsive">
        <table class="table table-striped table-hover" id="userTable">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Full Name</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ user.get_full_name }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.role|capfirst }}</td>
                    <td>
                        <a href="" class="btn btn-sm btn-warning">Edit</a>
                        <a href="{% url 'delete_user' user.id %}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center">No users found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <div class="d-flex justify-content-center align-items-center mt-3">
        <button id="prevPage" class="btn btn-secondary me-2">Previous</button>
        <span id="pageInfo" class="mx-2"></span>
        <button id="nextPage" class="btn btn-secondary ms-2">Next</button>
    </div>
</div>

<!-- JS: Search + Role Filter + Pagination -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const rowsPerPage = 8;
    const table = document.getElementById("userTable");
    const allRows = Array.from(table.querySelectorAll("tbody tr"));
    const searchInput = document.getElementById("searchInput");
    const roleFilter = document.getElementById("roleFilter");
    const prevBtn = document.getElementById("prevPage");
    const nextBtn = document.getElementById("nextPage");
    const pageInfo = document.getElementById("pageInfo");

    let currentPage = 1;
    let filteredRows = [...allRows];

    function filterRows() {
        const query = searchInput.value.toLowerCase();
        const role = roleFilter.value.toLowerCase();
        filteredRows = allRows.filter(row => {
            const textMatch = row.textContent.toLowerCase().includes(query);
            const roleMatch = role === "" || row.cells[4].textContent.toLowerCase() === role;
            return textMatch && roleMatch;
        });
        currentPage = 1;
        renderTable();
    }

    function renderTable() {
        allRows.forEach(row => row.style.display = "none");
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        filteredRows.slice(start, end).forEach(row => row.style.display = "");
        pageInfo.textContent = filteredRows.length > 0 ? `Page ${currentPage} of ${totalPages}` : "No results";
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage >= totalPages;
    }

    prevBtn.addEventListener("click", () => {
        if (currentPage > 1) currentPage--;
        renderTable();
    });

    nextBtn.addEventListener("click", () => {
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
        if (currentPage < totalPages) currentPage++;
        renderTable();
    });

    searchInput.addEventListener("input", filterRows);
    roleFilter.addEventListener("change", filterRows);

    renderTable();
});
</script>
{% endblock %}
