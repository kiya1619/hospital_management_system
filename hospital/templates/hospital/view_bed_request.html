{% extends "base.html" %}

{% block title %}Bed Requests{% endblock %}

{% block content %}
<h3>Bed Requests</h3>

<table class="table table-striped table-bordered mt-3">
    <thead class="table-dark">
        <tr>
            <th>Patient</th>
            <th>Requested By</th>
            <th>Status</th>
            <th>Date Requested</th>
            <th>Fulfilled By</th>
            <th>Date Fulfilled</th>
            <th>Notes</th>
            <th>Assigned Bed</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for request in bed_requests %}
        <tr>
            <td>{{ request.appointment.patient.user.get_full_name }}</td>
            <td>{{ request.requested_by.get_full_name }}</td>
            <td>
                {% if request.status == 'pending' %}
                    <span class="badge bg-warning text-dark">Pending</span>
                {% else %}
                    <span class="badge bg-success">Fulfilled</span>
                {% endif %}
            </td>
            <td>{{ request.date_requested|date:"Y-m-d H:i" }}</td>
            <td>{% if request.fulfilled_by %}{{ request.fulfilled_by.get_full_name }}{% else %}-{% endif %}</td>
            <td>{% if request.date_fulfilled %}{{ request.date_fulfilled|date:"Y-m-d H:i" }}{% else %}-{% endif %}</td>
            <td>{{ request.notes|default:"-" }}</td>
           <td>
    {% with assigned=request.assignment.first %}
    {% if assigned %}
        {{ assigned.bed.ward }} - {{ assigned.bed.bed_number }}
    {% else %}
        Pending
    {% endif %}
{% endwith %}

</td>

           <td>
    {% if request.status == 'pending' and user.role == 'nurse' %}
        <a href="{% url 'assign_bed' request.id %}" class="btn btn-sm btn-success">
            Take Action
        </a>
    {% else %}
        -
    {% endif %}
</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="8" class="text-center">No bed requests found.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}
