{% extends "base.html" %}
{% block title %}View Bedrooms{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-primary">
            <i class="fas fa-bed me-2"></i>Bedroom Management
        </h3>
        <input type="text" id="searchInput" class="form-control w-25" placeholder="🔍 Search ward or bed number...">
    </div>

    {% if beds %}
    <div class="table-responsive shadow-sm rounded">
        <table class="table table-hover align-middle">
            <thead class="table-primary text-center">
                <tr>
                    <th>Bed Number</th>
                    <th>Ward</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="bedsBody" class="text-center">
                {% for bed in beds %}
                <tr id="bedRow{{ bed.id }}">
                    <td>{{ bed.bed_number }}</td>
                    <td>{{ bed.ward }}</td>
                    <td>
                        {% if bed.status == 'available' %}
                            <span class="badge bg-success">Available</span>
                        {% elif bed.status == 'occupied' %}
                            <span class="badge bg-danger">Occupied</span>
                        {% else %}
                            <span class="badge bg-warning text-dark">Maintenance</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if bed.status == 'occupied' %}
                            <button class="btn btn-sm btn-outline-danger" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#releaseModal" 
                                    data-bed-id="{{ bed.id }}" 
                                    data-bed-number="{{ bed.bed_number }}">
                                Release
                            </button>
                        {% else %}
                            <button class="btn btn-sm btn-secondary" disabled>---</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination Section -->
    <div class="d-flex justify-content-between align-items-center mt-3" id="paginationSection">
        <div id="entriesInfo" class="text-muted small"></div>
        <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
    </div>

    {% else %}
        <div class="alert alert-info mt-3">No beds found in the system.</div>
    {% endif %}
</div>

<!-- 🛏️ Release Confirmation Modal -->
<div class="modal fade" id="releaseModal" tabindex="-1" aria-labelledby="releaseModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="releaseModalLabel"><i class="fas fa-bed me-2"></i>Release Bed</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <p>Are you sure you want to <strong>release bed <span id="bedNumberLabel"></span></strong>?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmReleaseBtn">Yes, Release</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const rowsPerPage = 10;
    const tableBody = document.getElementById("bedsBody");
    const searchInput = document.getElementById("searchInput");
    const pagination = document.getElementById("pagination");
    const entriesInfo = document.getElementById("entriesInfo");

    let allRows = Array.from(tableBody.querySelectorAll("tr"));
    let filteredRows = [...allRows];
    let currentPage = 1;

    // 🔹 Pagination Rendering
    function renderTable() {
        tableBody.innerHTML = "";
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const pageRows = filteredRows.slice(start, end);

        pageRows.forEach(row => tableBody.appendChild(row));
        updatePagination();
        updateEntriesInfo();
    }

    function updatePagination() {
        pagination.innerHTML = "";
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
        if (totalPages <= 1) {
            pagination.style.display = "none";
            return;
        } else {
            pagination.style.display = "flex";
        }

        const prev = document.createElement("li");
        prev.className = `page-item ${currentPage === 1 ? "disabled" : ""}`;
        prev.innerHTML = `<a class="page-link" href="#">«</a>`;
        prev.addEventListener("click", e => {
            e.preventDefault();
            if (currentPage > 1) currentPage--;
            renderTable();
        });
        pagination.appendChild(prev);

        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement("li");
            li.className = `page-item ${i === currentPage ? "active" : ""}`;
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener("click", e => {
                e.preventDefault();
                currentPage = i;
                renderTable();
            });
            pagination.appendChild(li);
        }

        const next = document.createElement("li");
        next.className = `page-item ${currentPage === totalPages ? "disabled" : ""}`;
        next.innerHTML = `<a class="page-link" href="#">»</a>`;
        next.addEventListener("click", e => {
            e.preventDefault();
            if (currentPage < totalPages) currentPage++;
            renderTable();
        });
        pagination.appendChild(next);
    }

    function updateEntriesInfo() {
        const total = filteredRows.length;
        const start = total ? (currentPage - 1) * rowsPerPage + 1 : 0;
        const end = Math.min(currentPage * rowsPerPage, total);
        entriesInfo.textContent = `Showing ${start}–${end} of ${total} beds`;
    }

    searchInput.addEventListener("input", () => {
        const query = searchInput.value.toLowerCase();
        filteredRows = allRows.filter(row => row.innerText.toLowerCase().includes(query));
        currentPage = 1;
        renderTable();
    });

    // 🛏️ Handle Release Modal
    const releaseModal = document.getElementById("releaseModal");
    const confirmBtn = document.getElementById("confirmReleaseBtn");
    let selectedBedId = null;

    releaseModal.addEventListener("show.bs.modal", event => {
        const button = event.relatedTarget;
        selectedBedId = button.getAttribute("data-bed-id");
        const bedNumber = button.getAttribute("data-bed-number");
        document.getElementById("bedNumberLabel").textContent = bedNumber;
    });

    confirmBtn.addEventListener("click", () => {
        if (!selectedBedId) return;

        // Send request to release bed (adjust URL as needed)
        fetch(`/release-bed/${selectedBedId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            }
        })
        .then(response => {
            if (response.ok) {
                const row = document.getElementById("bedRow" + selectedBedId);
                row.querySelector("td:nth-child(3)").innerHTML = '<span class="badge bg-success">Available</span>';
                row.querySelector("td:nth-child(4)").innerHTML = '<button class="btn btn-sm btn-secondary" disabled>---</button>';
                bootstrap.Modal.getInstance(releaseModal).hide();
            } else {
                alert("Error: Unable to release bed.");
            }
        })
        .catch(() => alert("Network error while releasing bed."));
    });

    renderTable();
});
</script>
{% endblock %}
